<!DOCTYPE html>
<html>

<head>
    <title>WebSocket 客户端</title>
    <style>
        #editor {
            width: 800px;
            height: 400px;
            border: 1px solid #ccc;
            padding: 10px;
            margin: 20px auto;
            font-family: 'SimHei', monospace; /* 使用黑体 */
            white-space: pre-wrap;
            overflow-y: auto;
        }

        .status {
            text-align: center;
            color: #666;
        }

        #editor div {
            min-height: 1em;
        }
    </style>
</head>

<body>
    <div id="editor" contenteditable="true"></div>
    <div class="status">状态: <span id="status">未连接</span></div>

    <script>
        const editor = document.getElementById('editor');
        const statusSpan = document.getElementById('status');
        let ws;
        let isLocalChange = false;
        let composing = false;

        function connect() {
            ws = new WebSocket('ws://localhost:9090/user/ws');

            ws.onopen = () => {
                statusSpan.textContent = '已连接';
                statusSpan.style.color = 'green';
                sendContent();
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (!isLocalChange) {
                    isLocalChange = true;
                    if (data.type === 'UPDATE') {
                        const lines = data.content.split('\n');
                        editor.innerHTML = lines.map(line =>
                            `<div>${line || '<br>'}</div>`
                        ).join('');
                    }
                    isLocalChange = false;
                }
            };

            ws.onclose = () => {
                statusSpan.textContent = '已断开';
                statusSpan.style.color = 'red';
                setTimeout(connect, 1000);
            };
        }

        editor.addEventListener('compositionstart', () => {
            composing = true;
        });

        editor.addEventListener('compositionend', () => {
            composing = false;
            sendContent();
        });

        editor.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                const newDiv = document.createElement('div');
                newDiv.innerHTML = '<br>';
                let currentDiv = range.startContainer;
                while (currentDiv && currentDiv.nodeName !== 'DIV') {
                    currentDiv = currentDiv.parentNode;
                }
                if (currentDiv) {
                    const textAfterCursor = currentDiv.textContent.substring(range.startOffset);
                    currentDiv.textContent = currentDiv.textContent.substring(0, range.startOffset);
                    if (textAfterCursor) {
                        newDiv.textContent = textAfterCursor;
                    }
                    currentDiv.parentNode.insertBefore(newDiv, currentDiv.nextSibling);
                } else {
                    editor.appendChild(newDiv);
                }
                range.selectNodeContents(newDiv);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
                sendContent();
            }
        });

        editor.addEventListener('input', (e) => {
            if (!composing && !isLocalChange) {
                sendContent();
                const selection = window.getSelection();
                const range = document.createRange();
                range.selectNodeContents(editor.lastChild);
                range.collapse(false);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        });

        editor.addEventListener('keyup', (e) => {
            if ((e.key === 'Delete' || e.key === 'Backspace') && !composing && !isLocalChange) {
                sendContent();
            }
        });

        function sendContent() {
            let content = '';
            for (const div of editor.children) {
                if (content) content += '\n';
                content += div.textContent;
            }
            const message = {
                type: 'UPDATE',
                content: content
            };
            ws.send(JSON.stringify(message));
        }

        connect();
    </script>
</body>

</html>