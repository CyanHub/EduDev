# 基于Hardhat的MetaMask区块链钱包

## **一、实验目的**

1. 熟练掌握 MetaMask 区块链钱包在浏览器中的安装、配置与使用方法，能够安全地管理以太坊账户和进行交易操作。
2. 学会搭建本地 hardhat 以太坊网络环境，了解其在开发和测试以太坊智能合约方面的优势和用途。
3. 能够在本地 hardhat 以太坊网络与 MetaMask 钱包之间建立连接，实现从钱包发起交易到本地网络的交互过程，包括部署智能合约、调用智能合约函数等操作，为进一步开发复杂的以太坊去中心化应用（DApps）奠定坚实基础。

## **二、实验仪器设备、试剂或材料**

1. 计算机。
2. 浏览器。
3. Node.js。

## **三、实验原理**

1. 面向MetaMask
   钱包工作机制：MetaMask 是一款运行在浏览器中的以太坊钱包插件，它为用户提供了一个直观的界面来管理以太坊账户和与以太坊网络进行交互。MetaMask 生成并存储用户的私钥，并通过加密技术确保私钥的安全性。当用户在浏览器中访问支持以太坊的网站或 DApp 时，MetaMask 可以注入一个以太坊提供程序对象（如 window.ethereum）到页面的 JavaScript 环境中，使得网站或 DApp 能够与 MetaMask 进行通信，例如请求用户授权交易、获取账户信息等。
2. hardhat 以太坊网络：hardhat 是一个用于以太坊开发的开发环境和框架，它提供了本地以太坊网络的模拟功能，方便开发者在本地进行智能合约的开发、测试和调试。hardhat 网络可以在开发者的本地计算机上快速启动，并且可以自定义网络参数，如挖矿难度、区块时间等。通过 hardhat，开发者可以使用 Solidity 语言编写智能合约，并利用其内置的测试工具和开发工具链对智能合约进行全面的测试和优化，然后再将智能合约部署到真实的以太坊网络或其他测试网络上。
3. MetaMask 与
   hardhat 网络连接原理：MetaMask 与本地
   hardhat 网络连接的关键在于将 MetaMask 配置为连接到本地 hardhat 网络的节点。在启动 hardhat 网络时，会显示网络的 RPC 地址和端口号，通过在 MetaMask 中手动添加自定义网络，将这些信息配置到 MetaMask 中，使得 MetaMask 能够与本地 hardhat 网络进行通信。这样，当用户在 MetaMask 中发起交易或其他操作时，请求会被发送到本地 hardhat 网络的节点进行处理，从而实现了在本地环境下使用 MetaMask 操作以太坊网络的目的。

## **四、实验内容与步骤**

### 1.需MetaMask 钱包安装与配置

- 打开 edge浏览器，在浏览器的插件商店中搜索 MetaMask。
- 点击 安装 按钮，将 MetaMask 插件安装到浏览器中。
- 安装完成后，在浏览器的插件栏中点击
  MetaMask 图标，启动 MetaMask 钱包。
- 如果是首次使用 MetaMask，会提示创建新钱包或导入已有钱包。选择创建新钱包，按照提示设置钱包密码，并妥善保存助记词。助记词是恢复钱包的重要凭证，务必确保其安全，不要泄露给他人。
- 创建完成后，MetaMask 会显示钱包的账户地址和以太币余额（初始余额为 0）。
- 选择展示视图,在网络中查看,然后使用钱包连接一个测试网比如(连接一个测试完),展示以太币余额,**截图如下**

### 2.本地 hardhat 以太坊网络搭建

- 创建一个新的项目文件夹，例如命名为
  hardhatStudy。
- 进入该项目文件夹，通过命令行完成Hardhat项目初始化
- 执行指令完成,初始化Node项目,安装Hardhat,启动并初始化Hardhat工程
- npm init;  npm install
  --save-dev hardhat;  npx hardhat
- 初始化Hardhat命令行效果**截图如下**
- 按照提示初始化一个 hardhat 项目。在初始化过程中选择空白项目。
- 项目初始化完成后，会生成一些默认的文件和文件夹结构,通过vscode打开该项目目录,完成目录结构**截图如下**
- 配置本地区块链网络,修改./hardhat.config.js配置文件; 注意：本地区块链网络的链ID固定为31337(隐式创建，未日志提示),设置本地地址为url: http://127.0.0.1:8545;
  hardhat.config.js代码**截图如下**
- 在项目文件夹的命令行中，执行 npx
  hardhat node 命令，启动本地 hardhat 以太坊网络。该命令会在本地启动一个以太坊节点，并显示节点的 RPC 地址和端口号，例如 http://127.0.0.1:8545。效果**截图如下**

### 3.创建测试合约并部署

- 在contracts文件夹中创建test.sol文件,编写一个测试合约,合约具有getSum方法,可以获取 合约内整数数组的和,代码**截图如下**
- 创建scripts目录,并添加test.js脚本完成本地网络中test合约的部署,test.js代码**截图如下**
- 在命令行中执行 npx hardhat
  run ./scripts/test.js --network localhost 指令完成部署
- 合约部署完成,以太坊网络中的合约地址展示**效果截图

**

- 在本地以太网络命令行中 获取合约地址, 在合约部署后会生成artifacts文件夹,在其中找到artifacts/contracts/test.sol/test.json文件; 获取其中的abi,在test文件夹中创建test.js文件导出contractAddress和abi;注意contractAddress就是合约地址,abi就是在test.json中获取的abi接口数组
- test文件夹中 test.js文件中的代码
  **截图如下**

### 4.MetaMask 连接本地 hardhat 网络

- 在浏览器中打开 MetaMask 钱包，通过右上角的网络切换按钮打开网络列表,点击添加网络按钮。
- 在网络列表中，选择 手动添加网络 选项。
- 在弹出的手动添加网络对话框中，填写以下信息：

  + 自定义网络名称，例如 GCC Local Network。
  + 新的 RPC URL：填写本地 hardhat 网络的 RPC 地址，即之前启动 hardhat 节点时显示的地址，例如 http://127.0.0.1:8545。
  + 链 ID：填写本地 hardhat 网络的链 ID，如之前在 hardhat.config.js 中配置的 31337。
  + 货币符号：自定义货币符号，例如 GO。
- 填写添加网络对话框效果**截图如下**
- 点击 保存 按钮，MetaMask 会尝试连接到本地 hardhat 网络。如果连接成功，MetaMask 会显示已连接到自定义网络，并且账户余额仍然为 0（因为本地 hardhat 网络是一个全新的测试网络，当前账户没有初始的以太币分配）。连接成功效果**截图如下**

### 5.MetaMask添加本地区块链账户

- 点击账户选项按钮,选择一个账户,并点击添加账户,选择导入账户
- 选择类型为私钥,填写本地hardhat网络提供的账户私钥,并点击导入
- 展示添加的账户具有10000的代币; **截图添加的账户信息界面如下**

### 6.连接本地区块链网络

- 在前端项目中创建js代码片段，通过metamask与本地区块链网络连接。
- 在test目录中创建index.html文件,其中的script代码段中实现  以当前浏览器metamask插件连接以太坊网络; **具体代码如下截图**
- 在浏览器运行此index.html代码片段，将唤醒metamask插件，询问是否许可。**效果截图如下**
- 至此，已使用前端js，通过metamask连接本地测试网络。
- 调用合约,继续编写js代码片段，通过合约abi与合约地址调用合约方法。
- 代码中导入ethers模块并
  通过test.js导入 abi, contractAddress, 然后获取合约实例并签名调用,创建合约实例调用合约中的getSum方法,具体实现代码**如下截图**
- 浏览器中获取的数据**效果截图如下**
